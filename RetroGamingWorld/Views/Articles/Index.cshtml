@model IEnumerable<RetroGamingWorld.Models.Article>
@{
    ViewData["Title"] = "Articole";
    var wishlistIds = (ViewBag.UserWishlist as List<int>) ?? new List<int>();
}
@if (ViewBag.message is not null)
{
<div class="d-flex justify-content-center align-items-center mb-5 p-4 rounded-3 shadow-sm bg-success text-black-50">@ViewBag.message</div>
}

<div class="d-flex justify-content-between align-items-center mb-5 p-4 rounded-3 shadow-sm bg-white border-start border-5 border-danger">
    <div>
        <h1 class="display-6 fw-bold mb-0">📚 Colecția de Articole</h1>
        <p class="text-muted mb-0">Exploarează istoria gaming-ului.</p>
    </div>
    
    @if (User.Identity.IsAuthenticated)
    {
        <a class="btn btn-retro" href="/Articles/New">
            <i class="bi bi-plus-lg"></i> Adaugă Articol
        </a>
    }
</div>
<div class="row align-items-center mb-4 g-2">
    
    <div class="col">
        <form method="GET" asp-action="Index" asp-controller="Articles">
            <div class="input-group">
                
                <input type="text" class="form-control" 
                       placeholder="Caută după numele, categoria sau autorul articolului..." 
                       name="search"
                       value="@ViewBag.SearchString">

                <select name="sortBy" class="form-select" style="max-width: 110px;">
                    <option value="rating" selected="@(ViewBag.SortBy == "rating")">Rating</option>
                    <option value="price" selected="@(ViewBag.SortBy == "price")">Preț</option>
                </select>

                <select name="sortOrder" class="form-select" style="max-width: 110px;">
                    <option value="desc" selected="@(ViewBag.SortOrder == "desc")">Descresc.</option>
                    <option value="asc" selected="@(ViewBag.SortOrder == "asc")">Cresc.</option>
                </select>

                <button class="btn btn-outline-danger" type="submit">Search</button>
            </div>
        </form>
    </div>


        <div class="col-auto">
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    
                    <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                        <a class="page-link border-secondary text-dark" 
                           href="@ViewBag.PaginationBaseUrl=@(ViewBag.CurrentPage - 1)" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>

                    @for (int i = 1; i <= ViewBag.lastPage; i++)
                    {
                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                            <a class="page-link border-secondary @(i == ViewBag.CurrentPage ? "bg-danger border-danger text-white" : "text-dark")" 
                               href="@ViewBag.PaginationBaseUrl=@i">
                                @i
                            </a>
                        </li>
                    }

                    <li class="page-item @(ViewBag.CurrentPage == ViewBag.lastPage ? "disabled" : "")">
                        <a class="page-link border-secondary text-dark" 
                           href="@ViewBag.PaginationBaseUrl=@(ViewBag.CurrentPage + 1)" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
</div>
<br />

<div class="row row-cols-1 row-cols-md-3 g-4 mb-5">
    @if(ViewBag.nrArticles == 0)
    {
        <p>Niciun articol nu se potrivește căutărilor.</p>
    }
    else
    @foreach (Article article in ViewBag.articles)
    {
        if(article is not null)
        {
            <div class="col">
            <div class="card h-100 shadow-sm border-0 card-hover-effect position-relative">
                
                <span class="position-absolute top-0 end-0 badge bg-danger m-3 shadow-sm">
                    @article.Category.CategoryName
                </span>
                
<<<<<<< Updated upstream
=======
<<<<<<< HEAD
                @* <div class="card-img-top bg-light d-flex justify-content-center align-items-center border-bottom"> *@
                         @if (!string.IsNullOrEmpty(article.Image))
                         {
                             <div class="ratio ratio-1x1">
                                 <img class="card-img-top object-fit-cover" src="@article.Image"/>
                             </div>
                         }
                         else
                         {
                             <span class="text-muted">Fără imagine</span>
                         }
                @* </div> *@
=======
>>>>>>> Stashed changes
                <div class="card-img-top bg-light d-flex align-items-center justify-content-center position-relative" style="height: 300px; overflow: hidden;">
                    @if (!string.IsNullOrEmpty(article.Image))
                    {
                        @* object-fit: cover -> Taie marginile automat ca să umple pătratul perfect *@
                        <img src="@article.Image" class="w-100 h-100" style="object-fit: cover;" alt="@article.Title">
                    }
                    else
                    {
                        <span class="text-muted">Fără Imagine</span>
                    }
                </div>
>>>>>>> 46ab68fa83f60e1d758d9a2a51f0ba2a2d14e8e8

                <div class="card-body">
                    @if (article.IsApproved == false)
                    {
                        <span class="badge bg-warning text-dark mb-2">În Așteptare</span>
                    }
                    
                    <h5 class="card-title fw-bold text-dark mt-2">@article.Title</h5>
                    
                    <p class="card-text small mb-1">
                        De: <span class="fw-semibold text-danger">@(article.User?.UserName ?? "Necunoscut")</span>
                    </p>
                    
                    <p class="card-text text-muted small">
                        @if (!string.IsNullOrEmpty(article.Content) && article.Content.Length > 100)
                        {
                            @article.Content.Substring(0, 100) <span class="text-danger">...</span>
                        }
                        else
                        {
                            @article.Content
                        }
                    </p>
                </div>
                @if (User.IsInRole("Administrator") && article.IsApproved == false)
                {
                    <div class="d-flex justify-content-center">
                        <form method="post" asp-action="Approve" asp-controller="Articles">
                        <input type="hidden" name="Id" value="@article.Id" />
                        <button class="btn btn-success" type="submit">Aprobă articol</button>
                        </form>
                    </div>
                    <br/>
                }
                @* Footer 1: Preț și Stoc (Rămâne neschimbat) *@
<div class="card-footer bg-white border-top-0 d-flex justify-content-evenly align-items-center pb-3">
    <p class="card-text small mb-1">
        <span class="fw-semibold text-danger">@article.Price.ToString()</span> RON
    </p>
    <p class="card-text small mb-1">
        Stoc: <span class="fw-semibold text-danger">@article.Stock.ToString()</span>
    </p>
</div>

@* Footer 2: Butoane (Aici am adăugat Coșul) *@
<div class="card-footer bg-white border-top-0 d-flex justify-content-between align-items-center pb-3">
    <small class="text-muted">
        📅 @article.Date.ToString("dd MMM yyyy")
    </small>

    <div class="btn-group">
        @* 1. Buton AFIȘEAZĂ (Existent) *@
        <a href="/Articles/Show/@article.Id" class="btn btn-sm btn-outline-secondary">
            Afișează
        </a>

        @* 2. Buton ADAUGĂ ÎN COȘ (NOU - Inserat aici) *@
        @if (User.IsInRole("User"))
        {
            @if (article.Stock > 0)
            {
                <form method="post" asp-controller="Cart" asp-action="Add" asp-route-articleId="@article.Id" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-success" title="Adaugă în coș">
                        🛒
                    </button>
                </form>
            }
            else
            {
                <button class="btn btn-sm btn-outline-secondary disabled" title="Stoc Epuizat">
                    🚫
                </button>
            }
        }

        @* 3. Buton WISHLIST (Logica ta originală intactă) *@
        @if (User.Identity.IsAuthenticated)
        {
            @if(User.IsInRole("User"))
            {
                @if (wishlistIds.Contains(article.Id))
                {
                    <form method="post" asp-controller="Wishlist" asp-action="Remove" asp-route-articleId="@article.Id" class="d-inline">
                        <button type="submit" class="btn btn-sm wishlist-btn added" title="Scoate din Wishlist">
                            💖
                        </button>
                    </form>
                }
                else
                {
                    <a class="btn btn-sm wishlist-btn" 
                       asp-controller="Wishlist" 
                       asp-action="Add" 
                       asp-route-articleId="@article.Id"
                       title="Adaugă în Wishlist">
                        ❤️
                    </a>
                }      
            }
        }
        else
        {
            <a class="btn btn-sm wishlist-btn" href="/Identity/Account/Login">
                ❤️
            </a>
        }

        @* 4. Butoane ADMIN/OWNER (Logica ta originală intactă) *@
        @if (User.Identity.IsAuthenticated)
        {
             <a href="/Articles/Edit/@article.Id" class="btn btn-sm btn-outline-primary">
                ✏️
            </a>
            @if (article.User != null && User.Identity.Name == article.User.UserName)
            {
                <form method="post" asp-action="Delete" asp-controller="Articles" class="d-inline">
                    <input type="hidden" name="Id" value="@article.Id" />
                    <button class="btn btn-sm btn-outline-danger" type="submit">🗑️</button>
                </form>
            }
        }
    </div>
</div>
            </div>
        </div>
        }
    }
</div>

                                
<div class="d-flex justify-content-center">
    <p>@ViewBag.CurrentPage / @ViewBag.LastPage</p>
</div>